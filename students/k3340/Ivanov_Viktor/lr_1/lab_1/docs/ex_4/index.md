# задание 4: многопользовательский чат

## описание
реализация полноценного многопользовательского чата с использованием библиотеки socket и threading в Python. чат поддерживает TCP протокол для надежной передачи данных и многопоточность для одновременной обработки множественных клиентских подключений.

## требования
Python 3.6+, библиотека socket (встроенная в Python), библиотека threading (встроенная в Python), библиотека json (встроенная в Python), библиотека datetime (встроенная в Python).

## структура проекта
`server.py` - многопользовательский чат-сервер с threading, `client.py` - клиентская часть чата с интерактивным интерфейсом, `README.md` - инструкции по запуску и использованию.

## особенности реализации

**максимальное количество баллов (100%)**
протокол TCP - надежная передача данных, библиотека threading - многопоточная обработка клиентов, многопользовательский режим - неограниченное количество участников.

**технические характеристики**
транспорт: TCP сокеты (SOCK_STREAM), порт: 8083, архитектура: многопоточная (threading), протокол обмена: JSON, кодировка: UTF-8.

**функциональность чата**
общие сообщения - отправка всем участникам, приватные сообщения - личная переписка между пользователями, приватные сессии - режим длительной приватной переписки, автоматическая отправка - сообщения автоматически идут в нужный режим, список пользователей - просмотр участников онлайн, уведомления - вход/выход пользователей, системные сообщения - информация о состоянии чата, временные метки - время отправки сообщений, счетчик онлайн - количество активных пользователей, визуальные индикаторы - показ текущего режима работы.

## запуск приложения

**запуск чат-сервера**
откройте первый терминал и выполните:
```bash
cd ex_4
python3 server.py
```

сервер запустится на localhost:8083 и будет ожидать подключений клиентов.

**запуск клиентов**
откройте дополнительные терминалы для каждого клиента:
```bash
cd ex_4
python3 client.py
```

каждый клиент должен ввести уникальное имя пользователя.

## использование чата

**основные команды**
обычное сообщение - просто введите текст и нажмите Enter, `/users` - показать список пользователей онлайн, `/session username` - начать приватную сессию с пользователем, `/exit` - выйти из приватной сессии, `/private username message` - отправить разовое приватное сообщение, `/quit` - выйти из чата.

**примеры использования**

**отправка общего сообщения**
```
Привет всем! Как дела?
```

**просмотр списка пользователей**
```
/users
```

**начало приватной сессии**
```
/session Alice
```
отправляется запрос Alice на приватную сессию. Alice получит уведомление и сможет принять или отклонить запрос.

**подтверждение сессии**
введите `y` для принятия приватной сессии, введите `n` для отклонения приватной сессии.

**выход из приватной сессии**
```
/exit
```

**разовое приватное сообщение**
```
/private Alice Привет! Как дела?
```

**выход из чата**
```
/quit
```

## архитектура системы

**серверная часть**
ChatServer - основной поток (принятие подключений), поток клиента 1 (обработка сообщений), поток клиента 2 (обработка сообщений), поток клиента N (обработка сообщений), общие ресурсы (список клиентов, блокировки).

**клиентская часть**
ChatClient - основной поток (ввод сообщений), поток получения (получение сообщений от сервера).

## протокол обмена сообщениями

**типы сообщений**

**1. подключение пользователя**
```json
{
    "username": "Alice"
}
```

**2. обычное сообщение**
```json
{
    "type": "message",
    "message": "Привет всем!"
}
```

**3. приватное сообщение**
```json
{
    "type": "private",
    "target_username": "Bob",
    "message": "Привет! Как дела?"
}
```

**4. запрос приватной сессии**
```json
{
    "type": "session_request",
    "target_username": "Bob"
}
```

**5. ответ на запрос приватной сессии**
```json
{
    "type": "session_response",
    "target_username": "Alice",
    "accepted": true
}
```

**6. запрос списка пользователей**
```json
{
    "type": "users"
}
```

**ответы сервера**

**системное сообщение**
```json
{
    "type": "system",
    "message": "Добро пожаловать в чат, Alice!",
    "timestamp": "2024-01-15T14:30:00",
    "online_users": 3
}
```

**список пользователей**
```json
{
    "type": "users_list",
    "users": ["Alice", "Bob", "Charlie"],
    "timestamp": "2024-01-15T14:30:00"
}
```

**приватное сообщение**
```json
{
    "type": "private",
    "from_username": "Bob",
    "message": "Привет! Как дела?",
    "timestamp": "2024-01-15T14:30:00"
}
```

**запрос приватной сессии**
```json
{
    "type": "session_request",
    "from_username": "Alice",
    "message": "Alice хочет начать приватную сессию с вами",
    "timestamp": "2024-01-15T14:30:00"
}
```

**подтверждение сессии**
```json
{
    "type": "session_accepted",
    "from_username": "Alice",
    "to_username": "Bob",
    "message": "Приватная сессия между Alice и Bob установлена",
    "timestamp": "2024-01-15T14:30:00"
}
```

**отклонение сессии**
```json
{
    "type": "session_rejected",
    "from_username": "Alice",
    "to_username": "Bob",
    "message": "Приватная сессия между Alice и Bob отклонена",
    "timestamp": "2024-01-15T14:30:00"
}
```

## безопасность и надежность

**защита от ошибок**
обработка исключений - корректная обработка всех ошибок, валидация данных - проверка корректности JSON, graceful shutdown - корректное завершение работы.

**синхронизация потоков**
Threading.Lock - защита общих ресурсов, атомарные операции - безопасное добавление/удаление клиентов, изоляция данных - каждый поток работает с собственными данными.

**управление соединениями**
автоматическое отключение - удаление неактивных клиентов, проверка состояния - мониторинг соединений, очистка ресурсов - освобождение памяти и сокетов.

## тестирование

**сценарии тестирования**
подключение нескольких клиентов - проверка многопользовательского режима, отправка общих сообщений - проверка broadcast функциональности, приватные сообщения - проверка личной переписки, отключение клиентов - проверка корректного удаления, обработка ошибок - проверка устойчивости к сбоям.

**пример тестирования**
```bash
# Терминал 1: Сервер
cd ex_4
python3 server.py

# Терминал 2: Клиент 1
cd ex_4
python3 client.py
# Введите имя: Alice

# Терминал 3: Клиент 2
cd ex_4
python3 client.py
# Введите имя: Bob

# Теперь можно общаться между клиентами!
```

## остановка сервера
для остановки чат-сервера нажмите Ctrl+C в терминале, где запущен сервер.

## примечания
сервер работает на порту 8083 (уникальный для каждого задания), поддерживается неограниченное количество одновременных подключений, все сообщения сохраняют временные метки, автоматическое определение отключившихся клиентов, поддержка русских символов в сообщениях.

## демонстрация работы

после запуска запустите сервер в первом терминале, запустите несколько клиентов в разных терминалах, введите имена пользователей для каждого клиента, отправляйте сообщения и наблюдайте за общением, используйте команды для дополнительной функциональности.

чат полностью функционален и готов к использованию.